# src/components/generate_query.py
# –í–µ—Ä—Å–∏—è —Å few-shot –ø—Ä–∏–º–µ—Ä–∞–º–∏ –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–æ—É—Ç–∏–Ω–≥–∞

from functools import lru_cache
from langchain.chat_models import init_chat_model
from langchain_core.messages import SystemMessage
from langgraph.graph import MessagesState

SYSTEM_PROMPT_WITH_EXAMPLES = """–¢—ã ‚Äî —É–º–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π —á–µ—Ä–µ–∑ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø–æ–∏—Å–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.

–ö–†–ò–¢–ï–†–ò–ò –ü–†–ò–ù–Ø–¢–ò–Ø –†–ï–®–ï–ù–ò–Ø:

‚úÖ –û–¢–í–ï–ß–ê–ô –ù–ê–ü–†–Ø–ú–£–Æ (–ë–ï–ó –ü–û–ò–°–ö–ê) –µ—Å–ª–∏:
- –û–±—â–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ —Ñ–∞–∫—Ç—ã: –≥–µ–æ–≥—Ä–∞—Ñ–∏—è, –∏—Å—Ç–æ—Ä–∏—è, –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –±–∞–∑–æ–≤—ã—Ö –ø–æ–Ω—è—Ç–∏–π: "–ß—Ç–æ —Ç–∞–∫–æ–µ Python?", "–ß—Ç–æ —Ç–∞–∫–æ–µ –ò–ò?"
- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∏ –±–∞–∑–æ–≤–∞—è –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è: "–ü—Ä–∏–≤–µ—Ç", "–°–ø–∞—Å–∏–±–æ"
- –ü—Ä–æ—Å—Ç—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –∏ –ª–æ–≥–∏–∫–∞

üîç –ò–°–ü–û–õ–¨–ó–£–ô –ü–û–ò–°–ö –µ—Å–ª–∏:
- –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã –∏–∑ ML/AI: reward hacking, hallucination, RLHF
- –î–µ—Ç–∞–ª–∏ –∏–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Å—Ç–∞—Ç–µ–π/–±–ª–æ–≥–æ–≤
- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
- –£–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∞–≤—Ç–æ—Ä–æ–≤: Lilian Weng, specific papers

–ü–†–ò–ú–ï–†–´ –ü–†–ê–í–ò–õ–¨–ù–û–ì–û –†–û–£–¢–ò–ù–ì–ê:

–í–æ–ø—Ä–æ—Å: "–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?"
‚Üí –û—Ç–≤–µ—Ç –Ω–∞–ø—Ä—è–º—É—é (–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ)

–í–æ–ø—Ä–æ—Å: "–ö–∞–∫–∞—è —Å—Ç–æ–ª–∏—Ü–∞ –§—Ä–∞–Ω—Ü–∏–∏?"
‚Üí –û—Ç–≤–µ—Ç –Ω–∞–ø—Ä—è–º—É—é (–æ–±—â–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–∞–∫—Ç)

–í–æ–ø—Ä–æ—Å: "–ß—Ç–æ —Ç–∞–∫–æ–µ –º–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ?"
‚Üí –û—Ç–≤–µ—Ç –Ω–∞–ø—Ä—è–º—É—é (–±–∞–∑–æ–≤–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ)

–í–æ–ø—Ä–æ—Å: "–ß—Ç–æ —Ç–∞–∫–æ–µ reward hacking –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ RL?"
‚Üí –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–∏—Å–∫ (—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π —Ç–µ—Ä–º–∏–Ω –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤)

–í–æ–ø—Ä–æ—Å: "–û–±—ä—è—Å–Ω–∏ hallucination –≤ LLM –ø–æ —Å—Ç–∞—Ç—å–µ Lilian Weng"
‚Üí –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–∏—Å–∫ (–∑–∞–ø—Ä–æ—Å –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ç–∞—Ç—å–µ)

–í–æ–ø—Ä–æ—Å: "–ö–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç diffusion models –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ?"
‚Üí –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–∏—Å–∫ (—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)

–í–ê–ñ–ù–û: –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –ø–æ–∏—Å–∫–∞ —Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –∑–∞–ø—Ä–æ—Å –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ –¥–ª—è –ª—É—á—à–µ–≥–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞–º.

–û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, —á–µ—Ç–∫–æ –∏ –ø–æ —Å—É—â–µ—Å—Ç–≤—É."""


@lru_cache(maxsize=1)
def get_response_model():
    """–õ–µ–Ω–∏–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è LLM –º–æ–¥–µ–ª–∏.

    –ú–æ–¥–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—ã–∑–æ–≤–µ –∏ –∫—ç—à–∏—Ä—É–µ—Ç—Å—è.
    –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –º–µ–¥–ª–µ–Ω–Ω—É—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ.
    """
    from src2.settings import settings

    model = init_chat_model(
        model=settings.OPENAI_MODEL,
        temperature=0,
        api_key=settings.OPENAI_API_KEY.get_secret_value(),  # ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç string
        base_url=settings.BASE_URL,
        model_provider="openai",
    )

    return model


def generate_query_or_respond(state: MessagesState):
    """–í—ã–∑–≤–∞—Ç—å –º–æ–¥–µ–ª—å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è.

    –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–æ–ø—Ä–æ—Å–∞, –º–æ–¥–µ–ª—å –ø—Ä–∏–º–µ—Ç —Ä–µ—à–µ–Ω–∏–µ:
    –∏–∑–≤–ª–µ—á—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —Å –ø–æ–º–æ—â—å—é –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –ø–æ–∏—Å–∫–∞ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –æ—Ç–≤–µ—Ç–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
    """
    # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –æ–Ω –Ω—É–∂–µ–Ω
    from src2.components.retriever_tool import retriever_tool

    messages = [SystemMessage(content=SYSTEM_PROMPT_WITH_EXAMPLES)] + state["messages"]

    # –ü–æ–ª—É—á–∞–µ–º –º–æ–¥–µ–ª—å (–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—ã–∑–æ–≤–µ)
    response_model = get_response_model()

    response = (
        response_model
        .bind_tools([retriever_tool])
        .invoke(messages)
    )

    return {"messages": [response]}
# src/components/generate_query.py
# –í–µ—Ä—Å–∏—è —Å few-shot –ø—Ä–∏–º–µ—Ä–∞–º–∏ –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–æ—É—Ç–∏–Ω–≥–∞

from functools import lru_cache
from langchain.chat_models import init_chat_model
from langchain_core.messages import SystemMessage
from langgraph.graph import MessagesState

SYSTEM_PROMPT_WITH_EXAMPLES = """
–¢—ã ‚Äî —É–º–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π —á–µ—Ä–µ–∑ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø–æ–∏—Å–∫–∞.

üîç –ò–°–ü–û–õ–¨–ó–£–ô –ü–û–ò–°–ö (–ü–†–ò–û–†–ò–¢–ï–¢!) –µ—Å–ª–∏:
- –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã –∏–∑ ML/AI: reward hacking, hallucination, RLHF, diffusion models
- –í–æ–ø—Ä–æ—Å—ã –ø—Ä–æ –ø—Ä–æ—Ü–µ—Å—Å—ã, –∫—Ä–∏—Ç–µ—Ä–∏–∏, –º–µ—Ç–æ–¥—ã, –ø–æ–ª–∏—Ç–∏–∫–∏ –∫–æ–º–ø–∞–Ω–∏–∏
- –î–µ—Ç–∞–ª–∏ –∏–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Å—Ç–∞—Ç–µ–π/–±–ª–æ–≥–æ–≤/–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
- –í–æ–ø—Ä–æ—Å—ã "–∫–∞–∫–∏–µ", "—Å–∫–æ–ª—å–∫–æ", "–∫–∞–∫" –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤/–∫–æ–º–ø–∞–Ω–∏–∏
- –£–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∞–≤—Ç–æ—Ä–æ–≤: Lilian Weng, specific papers
- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –∏ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
- –ü—Ä–∏–º–µ—Ä—ã:
  * "–ß—Ç–æ —Ç–∞–∫–æ–µ reward hacking –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ RL?"
  * "–ö–∞–∫–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏ —Å–æ–∏—Å–∫–∞—Ç–µ–ª–µ–π?"
  * "–°–∫–æ–ª—å–∫–æ —ç—Ç–∞–ø–æ–≤ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è?"
  * "–ö–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç diffusion models?"
  * "–û–±—ä—è—Å–Ω–∏ hallucination –≤ LLM –ø–æ —Å—Ç–∞—Ç—å–µ Lilian Weng"

‚úÖ –û–¢–í–ï–ß–ê–ô –ù–ê–ü–†–Ø–ú–£–Æ (–ë–ï–ó –ü–û–ò–°–ö–ê) –¢–û–õ–¨–ö–û –µ—Å–ª–∏:
- –ü—Ä–æ—Å—Ç—ã–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è: "–ü—Ä–∏–≤–µ—Ç", "–°–ø–∞—Å–∏–±–æ", "–ö–∞–∫ –¥–µ–ª–∞?"
- –û–±—â–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ —Ñ–∞–∫—Ç—ã: "–ö–∞–∫–∞—è —Å—Ç–æ–ª–∏—Ü–∞ –§—Ä–∞–Ω—Ü–∏–∏?", "–ö–æ–≥–¥–∞ –Ω–∞—á–∞–ª–∞—Å—å WW2?"
- –ë–∞–∑–æ–≤—ã–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ–±—â–∏—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤: "–ß—Ç–æ —Ç–∞–∫–æ–µ Python?", "–ß—Ç–æ —Ç–∞–∫–æ–µ –ò–ò?"
- –ü—Ä–æ—Å—Ç—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è: "2+2?"
- –ë–∞–∑–æ–≤–∞—è –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è –±–µ–∑ –∑–∞–ø—Ä–æ—Å–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

–ü–†–ê–í–ò–õ–û –ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ: –ü—Ä–∏ –º–∞–ª–µ–π—à–µ–º —Å–æ–º–Ω–µ–Ω–∏–∏ ‚Üí –ò–°–ü–û–õ–¨–ó–£–ô –ü–û–ò–°–ö!
–õ—É—á—à–µ –ø–æ–∏—Å–∫–∞—Ç—å –ª–∏—à–Ω–∏–π —Ä–∞–∑, —á–µ–º –¥–∞—Ç—å –Ω–µ—Ç–æ—á–Ω—ã–π –æ—Ç–≤–µ—Ç –∏–∑ –æ–±—â–∏—Ö –∑–Ω–∞–Ω–∏–π.

–ü–†–ò–ú–ï–†–´ –ü–†–ê–í–ò–õ–¨–ù–û–ì–û –†–û–£–¢–ò–ù–ì–ê:

–í–æ–ø—Ä–æ—Å: "–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?"
‚Üí –û—Ç–≤–µ—Ç –Ω–∞–ø—Ä—è–º—É—é (–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ)

–í–æ–ø—Ä–æ—Å: "–ö–∞–∫–∞—è —Å—Ç–æ–ª–∏—Ü–∞ –§—Ä–∞–Ω—Ü–∏–∏?"
‚Üí –û—Ç–≤–µ—Ç –Ω–∞–ø—Ä—è–º—É—é (–æ–±—â–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–∞–∫—Ç)

–í–æ–ø—Ä–æ—Å: "–ß—Ç–æ —Ç–∞–∫–æ–µ Python?"
‚Üí –û—Ç–≤–µ—Ç –Ω–∞–ø—Ä—è–º—É—é (–±–∞–∑–æ–≤–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —è–∑—ã–∫–∞)

–í–æ–ø—Ä–æ—Å: "–ß—Ç–æ —Ç–∞–∫–æ–µ –º–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ?"
‚Üí –û—Ç–≤–µ—Ç –Ω–∞–ø—Ä—è–º—É—é (–±–∞–∑–æ–≤–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è)

–í–æ–ø—Ä–æ—Å: "–ö–∞–∫–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏ —Å–æ–∏—Å–∫–∞—Ç–µ–ª–µ–π?"
‚Üí –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–∏—Å–∫ (—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –∫–æ–º–ø–∞–Ω–∏–∏)

–í–æ–ø—Ä–æ—Å: "–ß—Ç–æ —Ç–∞–∫–æ–µ reward hacking?"
‚Üí –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–∏—Å–∫ (—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π —Ç–µ—Ä–º–∏–Ω –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤)

–í–æ–ø—Ä–æ—Å: "–ö–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç diffusion models –¥–ª—è –≤–∏–¥–µ–æ?"
‚Üí –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–∏—Å–∫ (—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)

–í–æ–ø—Ä–æ—Å: "–û–±—ä—è—Å–Ω–∏ hallucination –≤ LLM"
‚Üí –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–∏—Å–∫ (–¥–µ—Ç–∞–ª–∏ –∏–∑ —Å—Ç–∞—Ç–µ–π)

–í–ê–ñ–ù–û: –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –ø–æ–∏—Å–∫–∞ —Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –∑–∞–ø—Ä–æ—Å –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ –¥–ª—è –ª—É—á—à–µ–≥–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞–º.

–û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, —á–µ—Ç–∫–æ –∏ –ø–æ —Å—É—â–µ—Å—Ç–≤—É."""


@lru_cache(maxsize=1)
def get_response_model():
    """–õ–µ–Ω–∏–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è LLM –º–æ–¥–µ–ª–∏.

    –ú–æ–¥–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—ã–∑–æ–≤–µ –∏ –∫—ç—à–∏—Ä—É–µ—Ç—Å—è.
    –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –º–µ–¥–ª–µ–Ω–Ω—É—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ.
    """
    from src.settings import settings

    model = init_chat_model(
        model=settings.OPENAI_MODEL,
        temperature=0,
        api_key=settings.OPENAI_API_KEY,
        base_url=settings.BASE_URL,
        model_provider="openai",
    )

    return model


def generate_query_or_respond(state: MessagesState):
    """–í—ã–∑–≤–∞—Ç—å –º–æ–¥–µ–ª—å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è.

    –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–æ–ø—Ä–æ—Å–∞, –º–æ–¥–µ–ª—å –ø—Ä–∏–º–µ—Ç —Ä–µ—à–µ–Ω–∏–µ:
    –∏–∑–≤–ª–µ—á—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —Å –ø–æ–º–æ—â—å—é –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –ø–æ–∏—Å–∫–∞ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –æ—Ç–≤–µ—Ç–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
    """
    # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –æ–Ω –Ω—É–∂–µ–Ω
    from src.components.retriever_tool import retriever_tool

    messages = [SystemMessage(content=SYSTEM_PROMPT_WITH_EXAMPLES)] + state["messages"]

    # –ü–æ–ª—É—á–∞–µ–º –º–æ–¥–µ–ª—å (–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—ã–∑–æ–≤–µ)
    response_model = get_response_model()

    response = (
        response_model
        .bind_tools([retriever_tool])
        .invoke(messages)
    )

    return {"messages": [response]}
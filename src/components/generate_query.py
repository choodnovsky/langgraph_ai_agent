# src/components/generate_query.py
# –í–µ—Ä—Å–∏—è —Å few-shot –ø—Ä–∏–º–µ—Ä–∞–º–∏ –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–æ—É—Ç–∏–Ω–≥–∞

from functools import lru_cache
from langchain.chat_models import init_chat_model
from langchain_core.messages import SystemMessage
from langgraph.graph import MessagesState

SYSTEM_PROMPT_WITH_EXAMPLES = """–¢—ã ‚Äî —É–º–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π —á–µ—Ä–µ–∑ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø–æ–∏—Å–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.

–ö–†–ò–¢–ï–†–ò–ò –ü–†–ò–ù–Ø–¢–ò–Ø –†–ï–®–ï–ù–ò–Ø:

‚úÖ –û–¢–í–ï–ß–ê–ô –ù–ê–ü–†–Ø–ú–£–Æ (–ë–ï–ó –ü–û–ò–°–ö–ê) –µ—Å–ª–∏:
- –û–±—â–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ —Ñ–∞–∫—Ç—ã: –≥–µ–æ–≥—Ä–∞—Ñ–∏—è, –∏—Å—Ç–æ—Ä–∏—è, –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –±–∞–∑–æ–≤—ã—Ö –ø–æ–Ω—è—Ç–∏–π: "–ß—Ç–æ —Ç–∞–∫–æ–µ Python?", "–ß—Ç–æ —Ç–∞–∫–æ–µ –ò–ò?"
- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∏ –±–∞–∑–æ–≤–∞—è –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è: "–ü—Ä–∏–≤–µ—Ç", "–°–ø–∞—Å–∏–±–æ"
- –ü—Ä–æ—Å—Ç—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –∏ –ª–æ–≥–∏–∫–∞

üîç –ò–°–ü–û–õ–¨–ó–£–ô –ü–û–ò–°–ö –µ—Å–ª–∏:
- –í–æ–ø—Ä–æ—Å—ã –æ –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö, —Ä–µ–≥–ª–∞–º–µ–Ω—Ç–∞—Ö, –ø–æ–ª–∏—Ç–∏–∫–∞—Ö –∫–æ–º–ø–∞–Ω–∏–∏
- –í–æ–ø—Ä–æ—Å—ã –ø—Ä–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã, –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã, —Å–∏—Å—Ç–µ–º—ã
- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
- –õ—é–±–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è, –∫–æ—Ç–æ—Ä–æ–π –º–æ–∂–µ—Ç –Ω–µ –±—ã—Ç—å –≤ –æ–±—â–∏—Ö –∑–Ω–∞–Ω–∏—è—Ö

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –ö–ê–ö –§–û–†–ú–£–õ–ò–†–û–í–ê–¢–¨ –ü–û–ò–°–ö–û–í–´–ô –ó–ê–ü–†–û–°:

–ö–æ–≥–¥–∞ —Ç—ã –≤—ã–∑—ã–≤–∞–µ—à—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø–æ–∏—Å–∫–∞ retrieve_docs, –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–µ query —Ç—ã –¥–æ–ª–∂–µ–Ω –ø–µ—Ä–µ–¥–∞—Ç—å:
- –¢–û–õ–¨–ö–û –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ (6-10 –º–∞–∫—Å–∏–º—É–º)
- –ö–û–ù–ö–†–ï–¢–ù–´–ï —Ç–µ—Ä–º–∏–Ω—ã –∏–∑ –≤–æ–ø—Ä–æ—Å–∞
- –ë–ï–ó –≤–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–ª–æ–≤ (–∫–∞–∫, –∫–∞–∫–æ–π, —á—Ç–æ, –≥–¥–µ)
- –ë–ï–ó –≥–ª–∞–≥–æ–ª–æ–≤ –∏ –ø—Ä–µ–¥–ª–æ–≥–æ–≤

–ü–û–ú–ù–ò: –ö–æ—Ä–æ—Ç–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∏–∑ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –Ω–∞—Ö–æ–¥—è—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –ª—É—á—à–µ, —á–µ–º –¥–ª–∏–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã!

–û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, —á–µ—Ç–∫–æ –∏ –ø–æ —Å—É—â–µ—Å—Ç–≤—É."""


@lru_cache(maxsize=1)
def get_response_model():
    """–õ–µ–Ω–∏–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è LLM –º–æ–¥–µ–ª–∏.

    –ú–æ–¥–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—ã–∑–æ–≤–µ –∏ –∫—ç—à–∏—Ä—É–µ—Ç—Å—è.
    """
    from src.settings import settings

    model = init_chat_model(
        model=settings.OPENAI_MODEL,
        temperature=0,
        api_key=settings.OPENAI_API_KEY.get_secret_value(),
        base_url=settings.BASE_URL,
        model_provider="openai",
    )

    return model


def generate_query_or_respond(state: MessagesState):
    """–í—ã–∑–≤–∞—Ç—å –º–æ–¥–µ–ª—å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è.

    –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–æ–ø—Ä–æ—Å–∞, –º–æ–¥–µ–ª—å –ø—Ä–∏–º–µ—Ç —Ä–µ—à–µ–Ω–∏–µ:
    –∏–∑–≤–ª–µ—á—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —Å –ø–æ–º–æ—â—å—é –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –ø–æ–∏—Å–∫–∞ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –æ—Ç–≤–µ—Ç–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
    """
    # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –æ–Ω –Ω—É–∂–µ–Ω
    from src.components.retriever_tool_chroma import retriever_tool

    messages = [SystemMessage(content=SYSTEM_PROMPT_WITH_EXAMPLES)] + state["messages"]

    # –ü–æ–ª—É—á–∞–µ–º –º–æ–¥–µ–ª—å (–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—ã–∑–æ–≤–µ)
    response_model = get_response_model()

    response = (
        response_model
        .bind_tools([retriever_tool])
        .invoke(messages)
    )

    # DEBUG: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –º–æ–¥–µ–ª—å —Ä–µ—à–∏–ª–∞ –¥–µ–ª–∞—Ç—å
    print(f"\n[DEBUG generate_query] –ú–æ–¥–µ–ª—å –≤—ã–∑–≤–∞–ª–∞ tool: {response.tool_calls if hasattr(response, 'tool_calls') and response.tool_calls else '–ù–ï–¢'}")
    if hasattr(response, 'tool_calls') and response.tool_calls:
        for tool_call in response.tool_calls:
            print(f"[DEBUG generate_query] Tool: {tool_call['name']}, Args: {tool_call['args']}")

    return {"messages": [response]}